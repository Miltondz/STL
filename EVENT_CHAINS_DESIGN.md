# üîó Sistema de Cadenas Narrativas Multi-Cap√≠tulo\n\n**Objetivo:** Eventos conectados que forman historias largas y ramificadas\n\n**Fecha:** 2025-10-29  \n**Estado:** Dise√±o conceptual\n\n---\n\n## üìñ Concepto: Event Chains\n\nLos **Event Chains** son secuencias de eventos interconectados que forman narrativas largas. Ejemplos:\n\n1. **\"La Base Abandonada\"** (3 cap√≠tulos)\n   - Cap√≠tulo 1: Encuentras base, activas beacon\n   - Cap√≠tulo 2: Nave enemiga llega por el beacon\n   - Cap√≠tulo 3: Confrontaci√≥n final\n\n2. **\"El Misterio de Vex\"** (4 cap√≠tulos)\n   - Cap√≠tulo 1: Transmisi√≥n fantasma (evento actual)\n   - Cap√≠tulo 2: Encuentras fragmentos Vex\n   - Cap√≠tulo 3: Capitana Vex revela su pasado\n   - Cap√≠tulo 4: Decisi√≥n final sobre la civilizaci√≥n Vex\n\n---\n\n## üèóÔ∏è Arquitectura de Event Chain\n\n### **Estructura JSON:**\n\n```json\n{\n  \"eventChains\": [\n    {\n      \"id\": \"arc_abandoned_base\",\n      \"title\": \"La Base Abandonada\",\n      \"description\": \"Una misteriosa instalaci√≥n en el espacio profundo\",\n      \"category\": \"exploration\",\n      \"chapters\": 3,\n      \"difficulty\": \"medium\",\n      \"startNode\": \"node_01\",\n      \"nodes\": [\n        {\n          \"id\": \"node_01\",\n          \"eventId\": \"enc_base_discovery\",\n          \"order\": 1,\n          \"nextNodes\": [\n            {\n              \"nodeId\": \"node_02_beacon\",\n              \"trigger\": \"on_specific_choice\",\n              \"choiceId\": \"opt_activate_beacon\"\n            },\n            {\n              \"nodeId\": \"node_02_explore\",\n              \"trigger\": \"on_specific_choice\",\n              \"choiceId\": \"opt_explore_quietly\"\n            }\n          ]\n        },\n        {\n          \"id\": \"node_02_beacon\",\n          \"eventId\": \"enc_beacon_consequences\",\n          \"order\": 2,\n          \"conditions\": [\n            {\n              \"type\": \"flag\",\n              \"target\": \"beacon_activated\",\n              \"operator\": \"equals\",\n              \"value\": true,\n              \"description\": \"Activaste el beacon\"\n            }\n          ],\n          \"nextNodes\": [\n            {\n              \"nodeId\": \"node_03_combat\",\n              \"trigger\": \"always\"\n            }\n          ]\n        },\n        {\n          \"id\": \"node_02_explore\",\n          \"eventId\": \"enc_quiet_exploration\",\n          \"order\": 2,\n          \"nextNodes\": [\n            {\n              \"nodeId\": \"node_03_discovery\",\n              \"trigger\": \"on_success\"\n            }\n          ]\n        },\n        {\n          \"id\": \"node_03_combat\",\n          \"eventId\": \"enc_pirate_ambush\",\n          \"order\": 3,\n          \"conditions\": [\n            {\n              \"type\": \"flag\",\n              \"target\": \"beacon_activated\",\n              \"operator\": \"equals\",\n              \"value\": true,\n              \"description\": \"Los piratas siguieron la se√±al del beacon\"\n            }\n          ]\n        },\n        {\n          \"id\": \"node_03_discovery\",\n          \"eventId\": \"enc_ancient_technology\",\n          \"order\": 3\n        }\n      ],\n      \"rewards\": {\n        \"onCompletion\": {\n          \"xp\": 100,\n          \"credits\": 50\n        }\n      },\n      \"narrative\": {\n        \"introduction\": \"Una se√±al d√©bil te lleva a una base aparentemente abandonada...\",\n        \"conclusion\": \"La base guarda sus secretos, pero tu elecci√≥n determin√≥ tu destino.\",\n        \"variations\": {\n          \"combat_path\": \"Tu decisi√≥n imprudente atrajo enemigos, pero sobreviviste.\",\n          \"stealth_path\": \"Tu cautela fue recompensada con conocimiento antiguo.\"\n        }\n      }\n    }\n  ]\n}\n```\n\n---\n\n## üéØ Eventos Individuales Modificados\n\nCada EventCard ahora puede pertenecer a una cadena:\n\n```json\n{\n  \"id\": \"enc_base_discovery\",\n  \"title\": \"Base Abandonada\",\n  \"type\": \"encounter\",\n  \"chainId\": \"arc_abandoned_base\",\n  \"chainNodeId\": \"node_01\",\n  \"chapterNumber\": 1,\n  \"narrative\": {\n    \"intro\": [\n      \"Cap√≠tulo 1: Descubrimiento\",\n      \"Tus sensores detectan una estructura artificial flotando en el vac√≠o...\"\n    ],\n    \"prompt\": \"¬øC√≥mo procedes?\"\n  },\n  \"options\": [\n    {\n      \"id\": \"opt_activate_beacon\",\n      \"text\": \"[ACTIVAR] Encender el beacon de emergencia\",\n      \"consequence\": {\n        \"rolls\": [\n          {\n            \"probability\": 100,\n            \"changes\": { \"xp\": 20 },\n            \"flags\": { \"beacon_activated\": true },\n            \"narrative\": {\n              \"log\": \"El beacon se enciende... enviando tu posici√≥n al espacio.\",\n              \"reaction\": \"Sistema: 'Beacon activado. Se√±al transmitida.'\"\n            }\n          }\n        ]\n      }\n    },\n    {\n      \"id\": \"opt_explore_quietly\",\n      \"text\": \"[EXPLORAR] Investigar sin hacer ruido\",\n      \"consequence\": {\n        \"rolls\": [\n          {\n            \"probability\": 100,\n            \"changes\": { \"xp\": 15 },\n            \"flags\": { \"stealth_approach\": true },\n            \"narrative\": {\n              \"log\": \"Te acercas cautelosamente a la base...\"\n            }\n          }\n        ]\n      }\n    },\n    {\n      \"id\": \"opt_abandon_chain\",\n      \"text\": \"[HUIR] Es demasiado peligroso\",\n      \"consequence\": {\n        \"rolls\": [\n          {\n            \"probability\": 100,\n            \"changes\": { \"moral\": -2 },\n            \"narrative\": {\n              \"log\": \"Decides alejarte. La tripulaci√≥n murmura sobre oportunidades perdidas.\"\n            }\n          }\n        ]\n      }\n    }\n  ],\n  \"canAbandon\": true,\n  \"abandonConsequence\": {\n    \"probability\": 100,\n    \"changes\": { \"moral\": -2 },\n    \"narrative\": {\n      \"log\": \"Abandonas la cadena narrativa. La tripulaci√≥n est√° decepcionada.\"\n    }\n  }\n}\n```\n\n---\n\n## üîß Motor de Cadenas Narrativas\n\n### **EventChainManager**\n\n```typescript\nclass EventChainManager {\n  private activeChains: Map<string, ChainProgress>;\n  private contentSchema: ContentSchema;\n  \n  constructor(schema: ContentSchema) {\n    this.contentSchema = schema;\n    this.activeChains = new Map();\n  }\n  \n  // Iniciar una nueva cadena\n  startChain(chainId: string, playerState: PlayerState): EventCard | null {\n    const chain = this.contentSchema.eventChains.find(c => c.id === chainId);\n    if (!chain) return null;\n    \n    const startNode = chain.nodes.find(n => n.id === chain.startNode);\n    if (!startNode) return null;\n    \n    // Marcar cadena como activa\n    this.activeChains.set(chainId, {\n      chainId,\n      currentNodeId: startNode.id,\n      visitedNodes: [],\n      completedAt: null\n    });\n    \n    return this.getEventForNode(startNode.eventId);\n  }\n  \n  // Procesar elecci√≥n y avanzar en la cadena\n  processChainChoice(chainId: string, nodeId: string, choiceId: string, playerState: PlayerState): EventCard | null {\n    const progress = this.activeChains.get(chainId);\n    const chain = this.getChain(chainId);\n    const currentNode = this.getNode(chainId, nodeId);\n    \n    if (!progress || !chain || !currentNode) return null;\n    \n    // Buscar pr√≥ximo nodo basado en la elecci√≥n\n    const nextNodeConfig = currentNode.nextNodes?.find(next => \n      next.trigger === 'on_specific_choice' && next.choiceId === choiceId\n    ) || currentNode.nextNodes?.find(next => \n      next.trigger === 'always'\n    );\n    \n    if (!nextNodeConfig) {\n      // Cadena termina\n      this.completeChain(chainId, playerState);\n      return null;\n    }\n    \n    const nextNode = this.getNode(chainId, nextNodeConfig.nodeId);\n    if (!nextNode) return null;\n    \n    // Verificar condiciones\n    if (!this.checkConditions(nextNode.conditions, playerState)) {\n      return null; // No se puede continuar\n    }\n    \n    // Avanzar progreso\n    progress.currentNodeId = nextNode.id;\n    progress.visitedNodes.push(nodeId);\n    \n    return this.getEventForNode(nextNode.eventId);\n  }\n  \n  // Verificar si hay cadenas que pueden activarse\n  checkForTriggeredChains(playerState: PlayerState): EventCard | null {\n    for (const chain of this.contentSchema.eventChains) {\n      if (this.activeChains.has(chain.id)) continue; // Ya activa\n      \n      const startNode = chain.nodes.find(n => n.id === chain.startNode);\n      if (!startNode) continue;\n      \n      // Verificar condiciones de inicio\n      if (this.checkConditions(startNode.conditions, playerState)) {\n        return this.startChain(chain.id, playerState);\n      }\n    }\n    return null;\n  }\n  \n  // Verificar condiciones\n  private checkConditions(conditions: EventChainCondition[] | undefined, playerState: PlayerState): boolean {\n    if (!conditions) return true;\n    \n    return conditions.every(condition => {\n      switch (condition.type) {\n        case 'flag':\n          const flagValue = playerState.narrativeFlags[condition.target!];\n          return this.compareValues(flagValue, condition.operator, condition.value);\n          \n        case 'crew_present':\n          return playerState.deck.some(card => card.cardId === condition.target);\n          \n        case 'stat_threshold':\n          const stat = (playerState as any)[condition.target!];\n          return this.compareValues(stat, condition.operator, condition.value);\n          \n        case 'death':\n          // Check if crew member died\n          return playerState.narrativeFlags[`crew_${condition.target}_dead`] === condition.value;\n          \n        default:\n          return true;\n      }\n    });\n  }\n  \n  private compareValues(actual: any, operator: string | undefined, expected: any): boolean {\n    switch (operator) {\n      case 'equals': return actual === expected;\n      case 'greater': return actual > expected;\n      case 'less': return actual < expected;\n      case 'contains': return Array.isArray(actual) ? actual.includes(expected) : false;\n      default: return true;\n    }\n  }\n}\n\ninterface ChainProgress {\n  chainId: string;\n  currentNodeId: string;\n  visitedNodes: string[];\n  completedAt: Date | null;\n}\n```\n\n---\n\n## üéÆ Ejemplo de Uso en el Juego\n\n### **Flujo de Cadena:**\n\n1. **Jugador llega a nodo ENCOUNTER**\n2. **EventManager verifica:**\n   ```typescript\n   // ¬øHay cadena activa?\n   const activeEvent = chainManager.getCurrentChainEvent(playerState);\n   if (activeEvent) return activeEvent;\n   \n   // ¬øPuede activarse nueva cadena?\n   const triggeredEvent = chainManager.checkForTriggeredChains(playerState);\n   if (triggeredEvent) return triggeredEvent;\n   \n   // Evento aleatorio normal\n   return getRandomEncounter();\n   ```\n\n3. **Jugador selecciona opci√≥n**\n4. **Se procesa consecuencia Y se avanza cadena:**\n   ```typescript\n   // Consecuencia normal\n   const result = processConsequence(option, playerState);\n   \n   // Avanzar cadena si aplica\n   const nextChainEvent = chainManager.processChainChoice(\n     currentEvent.chainId, \n     currentEvent.chainNodeId, \n     selectedOption.id, \n     newPlayerState\n   );\n   \n   // Marcar pr√≥ximo evento de cadena para el siguiente nodo\n   if (nextChainEvent) {\n     playerState.activeChainEvent = nextChainEvent.id;\n   }\n   ```\n\n---\n\n## üé® Editor Web para Cadenas\n\n### **Nueva Tab: \"Cadenas Narrativas\"**\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ [Eventos] [Cartas] [Naves] [Tiendas] [Cadenas]     ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ                                                     ‚îÇ\n‚îÇ  CADENAS NARRATIVAS                                 ‚îÇ\n‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ\n‚îÇ  ‚îÇ Lista de Cadenas    ‚îÇ  ‚îÇ Editor Visual      ‚îÇ   ‚îÇ\n‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ                    ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ ‚úì La Base Abandon.. ‚îÇ  ‚îÇ T√≠tulo: [input]    ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ ‚úì Misterio de Vex   ‚îÇ  ‚îÇ Descripci√≥n: [...] ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ ‚óã [Nueva Cadena]    ‚îÇ  ‚îÇ                    ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ NODOS:             ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ [1] Base Discovery ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ  ‚îú‚îÄ Beacon ‚Üí [2a]   ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ  ‚îî‚îÄ Explore ‚Üí [2b]  ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ [2a] Beacon Active  ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ  ‚îî‚îÄ Always ‚Üí [3a]   ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ [3a] Combat        ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ                    ‚îÇ   ‚îÇ\n‚îÇ  ‚îÇ                     ‚îÇ  ‚îÇ [+ Nodo] [Preview]  ‚îÇ   ‚îÇ\n‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n### **Funcionalidades del Editor:**\n\n‚úÖ **Diagrama Visual:** Nodos conectados con flechas  \n‚úÖ **Drag & Drop:** Reordenar nodos  \n‚úÖ **Condiciones Visuales:** \"Si X entonces Y\"  \n‚úÖ **Preview de Flujo:** Simular caminos  \n‚úÖ **Validaci√≥n de Referencias:** Verificar que eventos existen  \n‚úÖ **Testing:** Simular jugada completa de cadena  \n\n---\n\n## üìä Ejemplos de Cadenas\n\n### **1. \"La Base Abandonada\" (Exploraci√≥n)**\n\n```\nCap√≠tulo 1: Descubrimiento\n‚îú‚îÄ ACTIVAR BEACON\n‚îÇ  ‚îî‚îÄ Cap√≠tulo 2: Consecuencias\n‚îÇ     ‚îî‚îÄ Cap√≠tulo 3: Combate con Piratas\n‚îî‚îÄ EXPLORAR SILENCIO\n   ‚îî‚îÄ Cap√≠tulo 2: Exploraci√≥n Cautelosa\n      ‚îî‚îÄ Cap√≠tulo 3: Tecnolog√≠a Antigua\n```\n\n### **2. \"El Misterio de Vex\" (Narrativo)**\n\n```\nCap√≠tulo 1: Transmisi√≥n Fantasma (evento actual)\n‚îî‚îÄ [DECODIFICAR] con Dr. Thorn\n   ‚îî‚îÄ Cap√≠tulo 2: Fragmentos Vex\n      ‚îî‚îÄ Si tienes Capitana Vex\n         ‚îî‚îÄ Cap√≠tulo 3: Revelaci√≥n de Vex\n            ‚îî‚îÄ Cap√≠tulo 4: Decisi√≥n Final\n               ‚îú‚îÄ AYUDAR VEX ‚Üí Final \"Renacimiento\"\n               ‚îú‚îÄ DETENER VEX ‚Üí Final \"Guardi√°n\"\n               ‚îî‚îÄ IGNORAR VEX ‚Üí Final \"Neutral\"\n```\n\n### **3. \"Mot√≠n a Bordo\" (Interno)**\n\n```\nCap√≠tulo 1: Descontento\n‚îî‚îÄ Si moral < 5\n   ‚îî‚îÄ Cap√≠tulo 2: Tensi√≥n Creciente\n      ‚îî‚îÄ Si tripulante muere\n         ‚îî‚îÄ Cap√≠tulo 3: Confrontaci√≥n\n            ‚îú‚îÄ NEGOTIAR ‚Üí Reconciliaci√≥n\n            ‚îú‚îÄ FUERZA ‚Üí Represi√≥n\n            ‚îî‚îÄ CEDER ‚Üí Nueva Din√°mica\n```\n\n---\n\n## ‚ú® Beneficios de Event Chains\n\n‚úÖ **Narrativas Profundas:** Historias de m√∫ltiples cap√≠tulos  \n‚úÖ **Consecuencias Reales:** Decisiones tempranas afectan eventos futuros  \n‚úÖ **Replayabilidad:** M√∫ltiples caminos por cadena  \n‚úÖ **Inmersi√≥n:** El jugador siente que sus acciones importan  \n‚úÖ **Flexibilidad:** F√°cil agregar/quitar nodos  \n‚úÖ **Modularidad:** Cada evento sigue siendo independiente  \n\nEsta es una adici√≥n poderosa al sistema. ¬øEmpezamos implementando el dise√±o en los tipos TypeScript?\n"}