# üìã Narrativa y Eventos - Estado Actual de Implementaci√≥n\n\n**Documento de Auditor√≠a: Qu√© est√° implementado y c√≥mo**  \n**√öltima Actualizaci√≥n:** 2025-10-29  \n**Estado:** En desarrollo\n\n---\n\n## üîç RESUMEN EJECUTIVO\n\n**Implementado:**\n- ‚úÖ Sistema base de eventos con dos mazos (Encuentros y Peligros)\n- ‚úÖ 2 eventos de Encuentro totalmente funcionales con 6 opciones narrativas\n- ‚úÖ 2 eventos de Peligro con consecuencias autom√°ticas\n- ‚úÖ Sistema de banderas narrativas (narrative flags)\n- ‚úÖ Sistema de afinidad con tripulaci√≥n\n- ‚úÖ Requisitos condicionales (crew, cr√©ditos, flags)\n- ‚úÖ Componente React `EventCard` para renderizar eventos\n- ‚úÖ 8 personajes de tripulaci√≥n con narrativa\n- ‚úÖ Gestor de eventos centralizado\n\n**NO Implementado:**\n- ‚ùå Sistema de di√°logos din√°micos\n- ‚ùå Arcos narrativos largos\n- ‚ùå Eventos de campa√±a\n- ‚ùå Finales m√∫ltiples\n- ‚ùå M√°s de 4 eventos totales\n- ‚ùå Cinem√°ticas o transiciones narrativas\n- ‚ùå Sistema de consecuencias a largo plazo\n\n---\n\n## üìÅ ESTRUCTURA DE ARCHIVOS\n\n### **Archivos Principales:**\n\n```\nüì¶ Proyecto\n‚îú‚îÄ‚îÄ üìÇ constants.ts\n‚îÇ   ‚îî‚îÄ‚îÄ ENCOUNTER_DECK[]      ‚Üê 2 eventos de encuentro\n‚îÇ   ‚îî‚îÄ‚îÄ HAZARD_DECK[]         ‚Üê 2 eventos de peligro\n‚îÇ\n‚îú‚îÄ‚îÄ üìÇ types.ts\n‚îÇ   ‚îî‚îÄ‚îÄ EventCardData         ‚Üê Tipo de dato para eventos\n‚îÇ   ‚îî‚îÄ‚îÄ EventOption           ‚Üê Tipo de opci√≥n de evento\n‚îÇ   ‚îî‚îÄ‚îÄ EventConsequenceResult ‚Üê Consecuencias de eventos\n‚îÇ\n‚îú‚îÄ‚îÄ üìÇ services/\n‚îÇ   ‚îî‚îÄ‚îÄ eventManager.ts       ‚Üê L√≥gica de resoluci√≥n de eventos\n‚îÇ\n‚îú‚îÄ‚îÄ üìÇ components/\n‚îÇ   ‚îú‚îÄ‚îÄ EventCard.tsx         ‚Üê Renderizador visual de eventos\n‚îÇ   ‚îî‚îÄ‚îÄ CombatInterface.tsx   ‚Üê Integraci√≥n de eventos en UI\n‚îÇ\n‚îú‚îÄ‚îÄ üìÇ data/\n‚îÇ   ‚îî‚îÄ‚îÄ cards.ts              ‚Üê 8 personajes de tripulaci√≥n\n‚îÇ\n‚îî‚îÄ‚îÄ üìÇ hooks/\n    ‚îî‚îÄ‚îÄ useGameState.ts       ‚Üê Estado global con eventos\n```\n\n---\n\n## üé≠ EVENTOS IMPLEMENTADOS\n\n### **MAZO 1: ENCUENTROS (ENCOUNTER_DECK)**\n\nUbicaci√≥n: `constants.ts` l√≠neas ~120-200\n\n#### **Evento 1: Transmisi√≥n Fantasma**\n\n```typescript\nID: 'enc_ghost_transmission'\nT√≠tulo: 'Transmisi√≥n Fantasma'\nTipo: NodeType.ENCOUNTER\n```\n\n**Narrativa:**\n```\nIntro 1: \"Los sensores de largo alcance captan una transmisi√≥n an√≥mala...\"\nIntro 2: \"Es un antiguo c√≥digo de la Hegemon√≠a...\"\nIntro 3: \"La se√±al es d√©bil, pero inconfundible.\"\nPrompt: \"¬øC√≥mo procedes?\"\n```\n\n**Opciones Implementadas:**\n\n**OPCI√ìN 1: [DECODIFICAR]**\n- Requisito: `CREW_DR_ARIS_THORN` (Dr. Aris Thorn en mazo)\n- Probabilidad: 75% √©xito\n- **√âxito:**\n  - Reacci√≥n: \"Dr. Thorn: 'Interceptando el flujo de datos. Lo tengo.'\"\n  - Log: \"¬°El Dr. Thorn extrae un paquete de datos de una antigua ruta comercial! Ganas 15 cr√©ditos.\"\n  - Recompensas:\n    - `+15 cr√©ditos`\n    - `+40 XP`\n  - Bandera Narrativa: `ai_fragment_collected = true`\n  - Afinidad: Dr. Thorn `+1`\n  - Logro: `GHOST_IN_THE_MACHINE`\n\n- **Fallo (25%):**\n  - Reacci√≥n: \"Dr. Thorn: '¬°Cuidado, es una trampa de datos! ¬°Nos est√°n friendo los circuitos!'\"\n  - Log: \"El intento de decodificaci√≥n provoca una sobrecarga. La nave sufre 5 de da√±o al casco.\"\n  - Da√±o: `-5 casco`\n  - Afinidad: Dr. Thorn `-1`\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~130\n**Funci√≥n de consecuencia:** Callback que calcula resultado\n\n---\n\n**OPCI√ìN 2: [RESPONDER]**\n- Requisito: Bandera `knows_vex_code` (NO DESBLOQUEADA ACTUALMENTE)\n- Estado: Disponible pero bloqueada hasta futuros eventos\n- Resultado (cuando se desbloquee):\n  - Log: \"La transmisi√≥n cesa abruptamente, recibes coordenadas de encuentro secreto...\"\n  - Recompensas: `+50 XP`\n  - Efecto: Desbloquear√° nodo especial en mapa (no implementado a√∫n)\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~145\n\n---\n\n**OPCI√ìN 3: [IGNORAR]**\n- Requisito: Ninguno (siempre disponible)\n- Resultado:\n  - Log: \"Decides no arriesgarte. La tripulaci√≥n murmura sobre oportunidades perdidas, la moral disminuye.\"\n  - Efecto: `-1 moral`\n  - (Sistema de moral: Implementado pero no usado actualmente)\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~155\n\n---\n\n#### **Evento 2: Anomal√≠a Inestable**\n\n```typescript\nID: 'enc_unstable_anomaly'\nT√≠tulo: 'Anomal√≠a Inestable'\nTipo: NodeType.ENCOUNTER\n```\n\n**Narrativa:**\n```\nIntro 1: \"Los sensores chillan al detectar una fluctuaci√≥n espacial justo delante.\"\nIntro 2: \"Parece una bolsa de realidad inestable, brillando con energ√≠a contenida...\"\nPrompt: \"La prudencia es una opci√≥n. El riesgo, otra.\"\n```\n\n**Opciones Implementadas:**\n\n**OPCI√ìN 1: [ANALIZAR]**\n- Requisito: Ninguno\n- Probabilidad: 60% √©xito / 40% fallo\n- **√âxito (60%):**\n  - Log: \"¬°√âxito! Logras escanear la anomal√≠a antes de que se disipe...\"\n  - Recompensas: `+75 XP` (recompensa alta)\n\n- **Fallo (40%):**\n  - Log: \"¬°Fracaso! La anomal√≠a colapsa violentamente. Una onda de choque...\"\n  - Da√±o: `-5 a -12 casco` (aleatorio)\n  - Riesgo: Potencial muerte si casco est√° bajo\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~165\n\n---\n\n**OPCI√ìN 2: [EVITAR]**\n- Requisito: Ninguno\n- Resultado:\n  - Log: \"Rodeas la anomal√≠a, consumiendo 1 de combustible extra.\"\n  - Costo: `-1 combustible`\n  - Seguridad sobre recompensa\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~180\n\n---\n\n### **MAZO 2: PELIGROS (HAZARD_DECK)**\n\nUbicaci√≥n: `constants.ts` l√≠neas ~200-270\n\n#### **Peligro 1: Tormenta de Iones**\n\n```typescript\nID: 'haz_01'\nT√≠tulo: 'Tormenta de Iones'\nTipo: NodeType.HAZARD\n```\n\n**Caracter√≠sticas:**\n- Autom√°tico (sin opciones para rechazar)\n- Una sola opci√≥n: Soportar\n- Efecto: P√©rdida de combustible aleatorio (1-3)\n- Log: \"La tormenta de iones drena los sistemas. Pierdes [X] de combustible.\"\n\n**Mecanismo:**\n```typescript\nconsequence: (state) => {\n  const fuelLost = Math.floor(Math.random() * 3) + 1; // 1-3\n  return {\n    newState: { ...state, fuel: Math.max(0, state.fuel - fuelLost) },\n    log: `La tormenta de iones drena los sistemas. Pierdes ${fuelLost} de combustible.`\n  };\n}\n```\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~210\n\n---\n\n#### **Peligro 2: Campo de Asteroides Denso**\n\n```typescript\nID: 'haz_02'\nT√≠tulo: 'Campo de Asteroides Denso'\nTipo: NodeType.HAZARD\n```\n\n**Caracter√≠sticas:**\n- Autom√°tico con decisi√≥n √∫nica\n- Opci√≥n: Maniobras evasivas\n- Resultado: 50/50 entre dos consecuencias\n\n**Mecanismo:**\n```typescript\nif (Math.random() > 0.5) {\n  // 50% - √âxito\n  consume 2 de combustible\n} else {\n  // 50% - Fallo\n  pierde 5 cr√©ditos\n}\n```\n\n**Ubicaci√≥n en c√≥digo:** `constants.ts` l√≠nea ~235\n\n---\n\n## üîß C√ìMO EST√Å IMPLEMENTADO\n\n### **1. FLUJO DE UN EVENTO**\n\n```\nJugador llega a nodo ENCOUNTER\n    ‚Üì\neventManager.resolveNode(NodeType.ENCOUNTER)\n    ‚Üì\ngetEncounterCard() (obtiene una del mazo)\n    ‚Üì\nComponente EventCard renderiza la tarjeta\n    ‚Üì\nJugador ve intro text + opciones\n    ‚Üì\nonOptionSelect(option) ‚Üê jugador hace clic\n    ‚Üì\noption.consequence(playerState) ‚Üê calcula resultado\n    ‚Üì\nEventConsequenceResult se renderiza\n    ‚Üì\nonComplete() ‚Üê avanza el juego\n```\n\n### **2. TIPOS DE DATOS (types.ts)**\n\n```typescript\ninterface EventCardData {\n  id: string;                    // Identificador √∫nico\n  title: string;                 // T√≠tulo del evento\n  type: NodeType;                // ENCOUNTER o HAZARD\n  image?: string;                // URL de imagen\n  introText: string[];           // P√°rrafos narrativos\n  promptText: string;            // Pregunta/prompt\n  options: EventOption[];        // Array de opciones\n}\n\ninterface EventOption {\n  text: string;                  // Texto del bot√≥n\n  crewRequirement?: string;      // ID de tripulante requerido\n  requirements?: {               // Requisitos globales\n    credits?: number;\n    crew?: number;\n  };\n  narrativeFlagRequirement?: string; // Bandera requerida\n  consequence: (state: PlayerState) => EventConsequenceResult;\n}\n\ninterface EventConsequenceResult {\n  newState: PlayerState;         // Estado modificado\n  log: string;                   // Log narrativo\n  reactionText?: string;         // Di√°logo de NPC\n  xpGained?: number;             // XP a ganar\n  setNarrativeFlag?: {           // Bandera a activar\n    key: string;\n    value: boolean;\n  };\n  crewAffinityChange?: {         // Cambio de afinidad\n    crewId: string;\n    amount: number;\n  };\n  achievementId?: string;        // ID de logro\n}\n```\n\n**Ubicaci√≥n:** `types.ts`\n\n### **3. SERVICIO DE EVENTOS (eventManager.ts)**\n\n```typescript\nexport const resolveNode = (nodeType, playerState) => {\n  switch(nodeType) {\n    case NodeType.ENCOUNTER:\n      return { card: getEncounterCard() };\n    case NodeType.HAZARD:\n      return { card: getHazardCard() };\n    // ... otros tipos\n  }\n}\n\nconst getEncounterCard = () => {\n  // Filtra cartas no usadas en esta partida\n  const availableCards = ENCOUNTER_DECK.filter(\n    card => !usedEncounterCardIds.has(card.id)\n  );\n  // Si se acabaron, resetea\n  if (availableCards.length === 0) {\n    usedEncounterCardIds.clear();\n    return ENCOUNTER_DECK[random];\n  }\n  // Obtiene una aleatoria\n  const card = availableCards[random];\n  usedEncounterCardIds.add(card.id);\n  return card;\n}\n```\n\n**Funcionalidades:**\n- ‚úÖ Evita repetici√≥n de cartas en misma partida\n- ‚úÖ Resetea mazo cuando se acaban\n- ‚úÖ Selecci√≥n aleatoria\n\n**Ubicaci√≥n:** `services/eventManager.ts` l√≠neas 1-70\n\n### **4. COMPONENTE VISUAL (EventCard.tsx)**\n\n```typescript\ninterface EventCardProps {\n  card: EventCardData;                        // Tarjeta a mostrar\n  playerState: PlayerState;                   // Estado actual\n  onOptionSelect: (option: EventOption) => void; // Callback\n  onComplete: () => void;                     // Al terminar\n  eventResult: EventConsequenceResult | null; // Resultado\n}\n```\n\n**Funcionalidades:**\n- ‚úÖ Renderiza intro text l√≠nea por l√≠nea\n- ‚úÖ Muestra opciones como botones\n- ‚úÖ Desactiva opciones si requisitos no est√°n cumplidos\n- ‚úÖ Muestra motivo de bloqueo en rojo\n- ‚úÖ Renderiza resultado del evento\n- ‚úÖ Animaciones de fade-in-up\n\n**Validaci√≥n de requisitos:**\n```typescript\nconst checkRequirements = (option: EventOption) => {\n  if (option.requirements?.credits) {\n    if (playerState.credits < required)\n      return { met: false, reason: 'Cr√©ditos Insuficientes' };\n  }\n  if (option.crewRequirement) {\n    if (!playerState.deck.some(c => c.cardId === requirement))\n      return { met: false, reason: 'Requiere: [Tripulante]' };\n  }\n  if (option.narrativeFlagRequirement) {\n    if (!playerState.narrativeFlags[requirement])\n      return { met: false, reason: 'Condici√≥n no cumplida' };\n  }\n  return { met: true };\n};\n```\n\n**Ubicaci√≥n:** `components/EventCard.tsx`\n\n---\n\n## üë• PERSONAJES IMPLEMENTADOS\n\nUbicaci√≥n: `data/cards.ts`\n\n### **Con narrativa en eventos:**\n\n| Personaje | ID | Facci√≥n | Rarity | Precio | Narrativa |\n|-----------|----|---------|---------|---------|-----------|\n| **Dr. Aris Thorn** | `CREW_DR_ARIS_THORN` | Academia | Common | 7 | Decodifica Transmisi√≥n Fantasma (75% √©xito) |\n\n### **Sin narrativa en eventos (solo cartas):**\n\n| Personaje | ID | Facci√≥n | Rarity | Precio | Estado |\n|-----------|----|---------|---------|---------|-----------|\n| Kaelen Ingeniero | `CREW_KAELEN_INGENIERO` | Tecno-Gremio | Uncommon | 8 | Sin eventos |\n| Zara Artillera | `CREW_ZARA_ARTILLERA` | Mercenarios | Rare | 10 | Sin eventos |\n| Glitch Saboteador | `CREW_GLITCH_SABOTEADOR` | Hacktivistas | Rare | 9 | Sin eventos |\n| Capitana Vex | `CREW_CAPITANA_VEX` | Mercenarios | Rare | 12 | Sin eventos (potencial futuro) |\n| Zyx Comerciante | `CREW_ZYX_COMERCIANTE` | Comerciante | Common | 6 | Sin eventos |\n| Echo Piloto | `CREW_ECHO_PILOTO` | Neutral | Uncommon | 9 | Sin eventos |\n| Nyx Ps√≠quica | `CREW_NYX_PSIQUICA` | Academia | Rare | 11 | Sin eventos |\n\n---\n\n## üö© SISTEMA DE BANDERAS NARRATIVAS\n\nUbicaci√≥n: `PlayerState.narrativeFlags` (hooks/useGameState.ts)\n\n### **Banderas Implementadas:**\n\n**1. `ai_fragment_collected`**\n- **Activada por:** √âxito en [DECODIFICAR] - Transmisi√≥n Fantasma\n- **Valor:** boolean\n- **Uso actual:** Cosm√©tico (registrado pero no usado)\n- **Uso futuro:** Podr√≠a desbloquear eventos sobre IA\n\n### **Banderas Disponibles (No Activadas):**\n\n**2. `knows_vex_code`**\n- **Requisito para:** Opci√≥n [RESPONDER] en Transmisi√≥n Fantasma\n- **Estado:** Bloqueada (no hay evento que la active)\n- **Necesita:** Implementar evento anterior que otorgue esta bandera\n\n### **Sistema de Banderas:**\n\n```typescript\n// En PlayerState:\nnarrativeFlags: Record<string, boolean> = {}\n\n// Al resolver evento:\nif (consequence.setNarrativeFlag) {\n  playerState.narrativeFlags[key] = value;\n}\n\n// Para verificar:\nif (option.narrativeFlagRequirement) {\n  const hasFlag = playerState.narrativeFlags[requirement];\n  if (!hasFlag) return { met: false };\n}\n```\n\n---\n\n## ‚öôÔ∏è SISTEMA DE AFINIDAD\n\nUbicaci√≥n: `PlayerState.crewAffinity`\n\n**Implementaci√≥n:**\n```typescript\ncrewAffinity: Record<string, number> = {}\n\n// Cambio de afinidad en evento:\nif (consequence.crewAffinityChange) {\n  const { crewId, amount } = consequence.crewAffinityChange;\n  crewAffinity[crewId] = (crewAffinity[crewId] || 0) + amount;\n}\n```\n\n**Ejemplo:**\n- Dr. Thorn √©xito: `crewAffinity['CREW_DR_ARIS_THORN'] += 1`\n- Dr. Thorn fallo: `crewAffinity['CREW_DR_ARIS_THORN'] -= 1`\n\n**Uso actual:** Registrado pero no tiene efecto mec√°nico visible\n\n---\n\n## üèÜ LOGROS IMPLEMENTADOS\n\nUbicaci√≥n: `PlayerState.achievements[]`\n\n**Implementados:**\n\n| ID | Nombre | Activador | XP Bonus |\n|----|--------|-----------|----------|\n| `GHOST_IN_THE_MACHINE` | Ghost in the Machine | √âxito decodificar Transmisi√≥n Fantasma | 40 XP |\n\n**Sistema:**\n```typescript\nif (consequence.achievementId) {\n  playerState.achievements.push(achievementId);\n}\n```\n\n---\n\n## üìä ESTAD√çSTICAS DE IMPLEMENTACI√ìN\n\n### **Eventos:**\n- Total eventos: **4** (2 Encuentro + 2 Peligro)\n- Opciones totales: **6** (3 + 2 + 1 + 1)\n- Opciones con requisitos: **2** (crew requirement, flag requirement)\n- Opciones con probabilidad: **2** (75%, 60%)\n\n### **Narrativa:**\n- L√≠neas de intro text: **~10 p√°rrafos**\n- Personajes mencionados: **1** (Dr. Aris Thorn)\n- Banderas narrativas: **2 definidas** (1 activa, 1 bloqueada)\n- Logros: **1 implementado**\n\n### **Requisitos de Opci√≥n:**\n- Crew requirement: **1** (Dr. Aris Thorn)\n- Credits requirement: **0**\n- Narrative flag requirement: **1** (knows_vex_code - bloqueado)\n- Ninguno: **4** (siempre disponibles)\n\n---\n\n## üî¥ LIMITACIONES ACTUALES\n\n1. **Eventos Limitados:**\n   - Solo 4 eventos totales\n   - Mazo se agota r√°pidamente\n   - Poca variedad en sector\n\n2. **Narrativa Lineal:**\n   - No hay arcos narrativos largos\n   - Cada evento es independiente\n   - No hay consecuencias a largo plazo m√°s all√° de banderas\n\n3. **Personajes Subutilizados:**\n   - 8 personajes definidos pero solo 1 con narrativa en eventos\n   - No hay di√°logos complejos\n   - No hay arcos de personaje\n\n4. **Banderas Bloqueadas:**\n   - `knows_vex_code` no se puede obtener\n   - Opci√≥n [RESPONDER] permanentemente bloqueada\n   - Requerir√° crear evento anterior que la active\n\n5. **Mec√°nicas Incompletas:**\n   - Sistema de moral implementado pero no usado\n   - Afinidad registrada pero sin efectos\n   - Logros registrados pero sin UI de logros\n\n---\n\n## üõ£Ô∏è PR√ìXIMOS PASOS SUGERIDOS\n\n### **Corto Plazo (1-2 eventos):**\n1. Crear evento que active `knows_vex_code`\n2. Implementar opci√≥n [RESPONDER] completamente\n3. Crear 2-3 eventos m√°s para llevar a 6-7\n\n### **Mediano Plazo (3-5 eventos):**\n1. Implementar narrativa para otros personajes\n2. Crear eventos con requisitos de m√∫ltiples personajes\n3. Sistema de consecuencias a largo plazo\n4. Arcos narrativos cortos (2-3 eventos relacionados)\n\n### **Largo Plazo (Campa√±a completa):**\n1. Arcos de personaje completos\n2. Evento final con m√∫ltiples finales posibles\n3. Integraci√≥n total de Capitana Vex\n4. Sistema de decisiones que afecten el mapa/enemigos\n\n---\n\n## üìù NOTAS T√âCNICAS\n\n### **C√≥mo agregar un evento nuevo:**\n\n1. A√±adir a `ENCOUNTER_DECK` o `HAZARD_DECK` en `constants.ts`:\n```typescript\n{\n  id: 'enc_my_event',\n  title: 'Mi Evento',\n  type: NodeType.ENCOUNTER,\n  image: 'url',\n  introText: ['p√°rrafo 1', 'p√°rrafo 2'],\n  promptText: 'pregunta',\n  options: [{ ... }, { ... }]\n}\n```\n\n2. Implementar `consequence` callbacks\n3. Opcionalmente: agregar banderas, afinidad, logros\n4. El `eventManager` lo incluir√° autom√°ticamente\n\n### **C√≥mo agregar opci√≥n con requisito:**\n\n```typescript\n{\n  text: '[OPCI√ìN]',\n  crewRequirement: 'CREW_ID', // o narrativeFlagRequirement\n  consequence: (state) => ({ ... })\n}\n```\n\n### **Sistema de Random Aleatorio:**\n\nUtiliza `Math.random()` para probabilidades. Para mejor control, existe `rng.ts` con RNG determinista (para testing).\n\n---\n\n## üìö REFERENCIAS\n\n- Tipo `EventCardData`: `types.ts` l√≠nea ~120\n- Tipo `EventOption`: `types.ts` l√≠nea ~130\n- Constantes de eventos: `constants.ts` l√≠nea ~90\n- Servicio: `services/eventManager.ts`\n- Componente: `components/EventCard.tsx`\n- Datos de tripulaci√≥n: `data/cards.ts` l√≠nea ~80\n\n---\n\n**Documento generado:** 2025-10-29  \n**Pr√≥xima revisi√≥n:** Despu√©s de implementar nuevos eventos\n"}