# 📋 Narrativa y Eventos - Estado Actual de Implementación\n\n**Documento de Auditoría: Qué está implementado y cómo**  \n**Última Actualización:** 2025-10-29  \n**Estado:** En desarrollo\n\n---\n\n## 🔍 RESUMEN EJECUTIVO\n\n**Implementado:**\n- ✅ Sistema base de eventos con dos mazos (Encuentros y Peligros)\n- ✅ 2 eventos de Encuentro totalmente funcionales con 6 opciones narrativas\n- ✅ 2 eventos de Peligro con consecuencias automáticas\n- ✅ Sistema de banderas narrativas (narrative flags)\n- ✅ Sistema de afinidad con tripulación\n- ✅ Requisitos condicionales (crew, créditos, flags)\n- ✅ Componente React `EventCard` para renderizar eventos\n- ✅ 8 personajes de tripulación con narrativa\n- ✅ Gestor de eventos centralizado\n\n**NO Implementado:**\n- ❌ Sistema de diálogos dinámicos\n- ❌ Arcos narrativos largos\n- ❌ Eventos de campaña\n- ❌ Finales múltiples\n- ❌ Más de 4 eventos totales\n- ❌ Cinemáticas o transiciones narrativas\n- ❌ Sistema de consecuencias a largo plazo\n\n---\n\n## 📁 ESTRUCTURA DE ARCHIVOS\n\n### **Archivos Principales:**\n\n```\n📦 Proyecto\n├── 📂 constants.ts\n│   └── ENCOUNTER_DECK[]      ← 2 eventos de encuentro\n│   └── HAZARD_DECK[]         ← 2 eventos de peligro\n│\n├── 📂 types.ts\n│   └── EventCardData         ← Tipo de dato para eventos\n│   └── EventOption           ← Tipo de opción de evento\n│   └── EventConsequenceResult ← Consecuencias de eventos\n│\n├── 📂 services/\n│   └── eventManager.ts       ← Lógica de resolución de eventos\n│\n├── 📂 components/\n│   ├── EventCard.tsx         ← Renderizador visual de eventos\n│   └── CombatInterface.tsx   ← Integración de eventos en UI\n│\n├── 📂 data/\n│   └── cards.ts              ← 8 personajes de tripulación\n│\n└── 📂 hooks/\n    └── useGameState.ts       ← Estado global con eventos\n```\n\n---\n\n## 🎭 EVENTOS IMPLEMENTADOS\n\n### **MAZO 1: ENCUENTROS (ENCOUNTER_DECK)**\n\nUbicación: `constants.ts` líneas ~120-200\n\n#### **Evento 1: Transmisión Fantasma**\n\n```typescript\nID: 'enc_ghost_transmission'\nTítulo: 'Transmisión Fantasma'\nTipo: NodeType.ENCOUNTER\n```\n\n**Narrativa:**\n```\nIntro 1: \"Los sensores de largo alcance captan una transmisión anómala...\"\nIntro 2: \"Es un antiguo código de la Hegemonía...\"\nIntro 3: \"La señal es débil, pero inconfundible.\"\nPrompt: \"¿Cómo procedes?\"\n```\n\n**Opciones Implementadas:**\n\n**OPCIÓN 1: [DECODIFICAR]**\n- Requisito: `CREW_DR_ARIS_THORN` (Dr. Aris Thorn en mazo)\n- Probabilidad: 75% éxito\n- **Éxito:**\n  - Reacción: \"Dr. Thorn: 'Interceptando el flujo de datos. Lo tengo.'\"\n  - Log: \"¡El Dr. Thorn extrae un paquete de datos de una antigua ruta comercial! Ganas 15 créditos.\"\n  - Recompensas:\n    - `+15 créditos`\n    - `+40 XP`\n  - Bandera Narrativa: `ai_fragment_collected = true`\n  - Afinidad: Dr. Thorn `+1`\n  - Logro: `GHOST_IN_THE_MACHINE`\n\n- **Fallo (25%):**\n  - Reacción: \"Dr. Thorn: '¡Cuidado, es una trampa de datos! ¡Nos están friendo los circuitos!'\"\n  - Log: \"El intento de decodificación provoca una sobrecarga. La nave sufre 5 de daño al casco.\"\n  - Daño: `-5 casco`\n  - Afinidad: Dr. Thorn `-1`\n\n**Ubicación en código:** `constants.ts` línea ~130\n**Función de consecuencia:** Callback que calcula resultado\n\n---\n\n**OPCIÓN 2: [RESPONDER]**\n- Requisito: Bandera `knows_vex_code` (NO DESBLOQUEADA ACTUALMENTE)\n- Estado: Disponible pero bloqueada hasta futuros eventos\n- Resultado (cuando se desbloquee):\n  - Log: \"La transmisión cesa abruptamente, recibes coordenadas de encuentro secreto...\"\n  - Recompensas: `+50 XP`\n  - Efecto: Desbloqueará nodo especial en mapa (no implementado aún)\n\n**Ubicación en código:** `constants.ts` línea ~145\n\n---\n\n**OPCIÓN 3: [IGNORAR]**\n- Requisito: Ninguno (siempre disponible)\n- Resultado:\n  - Log: \"Decides no arriesgarte. La tripulación murmura sobre oportunidades perdidas, la moral disminuye.\"\n  - Efecto: `-1 moral`\n  - (Sistema de moral: Implementado pero no usado actualmente)\n\n**Ubicación en código:** `constants.ts` línea ~155\n\n---\n\n#### **Evento 2: Anomalía Inestable**\n\n```typescript\nID: 'enc_unstable_anomaly'\nTítulo: 'Anomalía Inestable'\nTipo: NodeType.ENCOUNTER\n```\n\n**Narrativa:**\n```\nIntro 1: \"Los sensores chillan al detectar una fluctuación espacial justo delante.\"\nIntro 2: \"Parece una bolsa de realidad inestable, brillando con energía contenida...\"\nPrompt: \"La prudencia es una opción. El riesgo, otra.\"\n```\n\n**Opciones Implementadas:**\n\n**OPCIÓN 1: [ANALIZAR]**\n- Requisito: Ninguno\n- Probabilidad: 60% éxito / 40% fallo\n- **Éxito (60%):**\n  - Log: \"¡Éxito! Logras escanear la anomalía antes de que se disipe...\"\n  - Recompensas: `+75 XP` (recompensa alta)\n\n- **Fallo (40%):**\n  - Log: \"¡Fracaso! La anomalía colapsa violentamente. Una onda de choque...\"\n  - Daño: `-5 a -12 casco` (aleatorio)\n  - Riesgo: Potencial muerte si casco está bajo\n\n**Ubicación en código:** `constants.ts` línea ~165\n\n---\n\n**OPCIÓN 2: [EVITAR]**\n- Requisito: Ninguno\n- Resultado:\n  - Log: \"Rodeas la anomalía, consumiendo 1 de combustible extra.\"\n  - Costo: `-1 combustible`\n  - Seguridad sobre recompensa\n\n**Ubicación en código:** `constants.ts` línea ~180\n\n---\n\n### **MAZO 2: PELIGROS (HAZARD_DECK)**\n\nUbicación: `constants.ts` líneas ~200-270\n\n#### **Peligro 1: Tormenta de Iones**\n\n```typescript\nID: 'haz_01'\nTítulo: 'Tormenta de Iones'\nTipo: NodeType.HAZARD\n```\n\n**Características:**\n- Automático (sin opciones para rechazar)\n- Una sola opción: Soportar\n- Efecto: Pérdida de combustible aleatorio (1-3)\n- Log: \"La tormenta de iones drena los sistemas. Pierdes [X] de combustible.\"\n\n**Mecanismo:**\n```typescript\nconsequence: (state) => {\n  const fuelLost = Math.floor(Math.random() * 3) + 1; // 1-3\n  return {\n    newState: { ...state, fuel: Math.max(0, state.fuel - fuelLost) },\n    log: `La tormenta de iones drena los sistemas. Pierdes ${fuelLost} de combustible.`\n  };\n}\n```\n\n**Ubicación en código:** `constants.ts` línea ~210\n\n---\n\n#### **Peligro 2: Campo de Asteroides Denso**\n\n```typescript\nID: 'haz_02'\nTítulo: 'Campo de Asteroides Denso'\nTipo: NodeType.HAZARD\n```\n\n**Características:**\n- Automático con decisión única\n- Opción: Maniobras evasivas\n- Resultado: 50/50 entre dos consecuencias\n\n**Mecanismo:**\n```typescript\nif (Math.random() > 0.5) {\n  // 50% - Éxito\n  consume 2 de combustible\n} else {\n  // 50% - Fallo\n  pierde 5 créditos\n}\n```\n\n**Ubicación en código:** `constants.ts` línea ~235\n\n---\n\n## 🔧 CÓMO ESTÁ IMPLEMENTADO\n\n### **1. FLUJO DE UN EVENTO**\n\n```\nJugador llega a nodo ENCOUNTER\n    ↓\neventManager.resolveNode(NodeType.ENCOUNTER)\n    ↓\ngetEncounterCard() (obtiene una del mazo)\n    ↓\nComponente EventCard renderiza la tarjeta\n    ↓\nJugador ve intro text + opciones\n    ↓\nonOptionSelect(option) ← jugador hace clic\n    ↓\noption.consequence(playerState) ← calcula resultado\n    ↓\nEventConsequenceResult se renderiza\n    ↓\nonComplete() ← avanza el juego\n```\n\n### **2. TIPOS DE DATOS (types.ts)**\n\n```typescript\ninterface EventCardData {\n  id: string;                    // Identificador único\n  title: string;                 // Título del evento\n  type: NodeType;                // ENCOUNTER o HAZARD\n  image?: string;                // URL de imagen\n  introText: string[];           // Párrafos narrativos\n  promptText: string;            // Pregunta/prompt\n  options: EventOption[];        // Array de opciones\n}\n\ninterface EventOption {\n  text: string;                  // Texto del botón\n  crewRequirement?: string;      // ID de tripulante requerido\n  requirements?: {               // Requisitos globales\n    credits?: number;\n    crew?: number;\n  };\n  narrativeFlagRequirement?: string; // Bandera requerida\n  consequence: (state: PlayerState) => EventConsequenceResult;\n}\n\ninterface EventConsequenceResult {\n  newState: PlayerState;         // Estado modificado\n  log: string;                   // Log narrativo\n  reactionText?: string;         // Diálogo de NPC\n  xpGained?: number;             // XP a ganar\n  setNarrativeFlag?: {           // Bandera a activar\n    key: string;\n    value: boolean;\n  };\n  crewAffinityChange?: {         // Cambio de afinidad\n    crewId: string;\n    amount: number;\n  };\n  achievementId?: string;        // ID de logro\n}\n```\n\n**Ubicación:** `types.ts`\n\n### **3. SERVICIO DE EVENTOS (eventManager.ts)**\n\n```typescript\nexport const resolveNode = (nodeType, playerState) => {\n  switch(nodeType) {\n    case NodeType.ENCOUNTER:\n      return { card: getEncounterCard() };\n    case NodeType.HAZARD:\n      return { card: getHazardCard() };\n    // ... otros tipos\n  }\n}\n\nconst getEncounterCard = () => {\n  // Filtra cartas no usadas en esta partida\n  const availableCards = ENCOUNTER_DECK.filter(\n    card => !usedEncounterCardIds.has(card.id)\n  );\n  // Si se acabaron, resetea\n  if (availableCards.length === 0) {\n    usedEncounterCardIds.clear();\n    return ENCOUNTER_DECK[random];\n  }\n  // Obtiene una aleatoria\n  const card = availableCards[random];\n  usedEncounterCardIds.add(card.id);\n  return card;\n}\n```\n\n**Funcionalidades:**\n- ✅ Evita repetición de cartas en misma partida\n- ✅ Resetea mazo cuando se acaban\n- ✅ Selección aleatoria\n\n**Ubicación:** `services/eventManager.ts` líneas 1-70\n\n### **4. COMPONENTE VISUAL (EventCard.tsx)**\n\n```typescript\ninterface EventCardProps {\n  card: EventCardData;                        // Tarjeta a mostrar\n  playerState: PlayerState;                   // Estado actual\n  onOptionSelect: (option: EventOption) => void; // Callback\n  onComplete: () => void;                     // Al terminar\n  eventResult: EventConsequenceResult | null; // Resultado\n}\n```\n\n**Funcionalidades:**\n- ✅ Renderiza intro text línea por línea\n- ✅ Muestra opciones como botones\n- ✅ Desactiva opciones si requisitos no están cumplidos\n- ✅ Muestra motivo de bloqueo en rojo\n- ✅ Renderiza resultado del evento\n- ✅ Animaciones de fade-in-up\n\n**Validación de requisitos:**\n```typescript\nconst checkRequirements = (option: EventOption) => {\n  if (option.requirements?.credits) {\n    if (playerState.credits < required)\n      return { met: false, reason: 'Créditos Insuficientes' };\n  }\n  if (option.crewRequirement) {\n    if (!playerState.deck.some(c => c.cardId === requirement))\n      return { met: false, reason: 'Requiere: [Tripulante]' };\n  }\n  if (option.narrativeFlagRequirement) {\n    if (!playerState.narrativeFlags[requirement])\n      return { met: false, reason: 'Condición no cumplida' };\n  }\n  return { met: true };\n};\n```\n\n**Ubicación:** `components/EventCard.tsx`\n\n---\n\n## 👥 PERSONAJES IMPLEMENTADOS\n\nUbicación: `data/cards.ts`\n\n### **Con narrativa en eventos:**\n\n| Personaje | ID | Facción | Rarity | Precio | Narrativa |\n|-----------|----|---------|---------|---------|-----------|\n| **Dr. Aris Thorn** | `CREW_DR_ARIS_THORN` | Academia | Common | 7 | Decodifica Transmisión Fantasma (75% éxito) |\n\n### **Sin narrativa en eventos (solo cartas):**\n\n| Personaje | ID | Facción | Rarity | Precio | Estado |\n|-----------|----|---------|---------|---------|-----------|\n| Kaelen Ingeniero | `CREW_KAELEN_INGENIERO` | Tecno-Gremio | Uncommon | 8 | Sin eventos |\n| Zara Artillera | `CREW_ZARA_ARTILLERA` | Mercenarios | Rare | 10 | Sin eventos |\n| Glitch Saboteador | `CREW_GLITCH_SABOTEADOR` | Hacktivistas | Rare | 9 | Sin eventos |\n| Capitana Vex | `CREW_CAPITANA_VEX` | Mercenarios | Rare | 12 | Sin eventos (potencial futuro) |\n| Zyx Comerciante | `CREW_ZYX_COMERCIANTE` | Comerciante | Common | 6 | Sin eventos |\n| Echo Piloto | `CREW_ECHO_PILOTO` | Neutral | Uncommon | 9 | Sin eventos |\n| Nyx Psíquica | `CREW_NYX_PSIQUICA` | Academia | Rare | 11 | Sin eventos |\n\n---\n\n## 🚩 SISTEMA DE BANDERAS NARRATIVAS\n\nUbicación: `PlayerState.narrativeFlags` (hooks/useGameState.ts)\n\n### **Banderas Implementadas:**\n\n**1. `ai_fragment_collected`**\n- **Activada por:** Éxito en [DECODIFICAR] - Transmisión Fantasma\n- **Valor:** boolean\n- **Uso actual:** Cosmético (registrado pero no usado)\n- **Uso futuro:** Podría desbloquear eventos sobre IA\n\n### **Banderas Disponibles (No Activadas):**\n\n**2. `knows_vex_code`**\n- **Requisito para:** Opción [RESPONDER] en Transmisión Fantasma\n- **Estado:** Bloqueada (no hay evento que la active)\n- **Necesita:** Implementar evento anterior que otorgue esta bandera\n\n### **Sistema de Banderas:**\n\n```typescript\n// En PlayerState:\nnarrativeFlags: Record<string, boolean> = {}\n\n// Al resolver evento:\nif (consequence.setNarrativeFlag) {\n  playerState.narrativeFlags[key] = value;\n}\n\n// Para verificar:\nif (option.narrativeFlagRequirement) {\n  const hasFlag = playerState.narrativeFlags[requirement];\n  if (!hasFlag) return { met: false };\n}\n```\n\n---\n\n## ⚙️ SISTEMA DE AFINIDAD\n\nUbicación: `PlayerState.crewAffinity`\n\n**Implementación:**\n```typescript\ncrewAffinity: Record<string, number> = {}\n\n// Cambio de afinidad en evento:\nif (consequence.crewAffinityChange) {\n  const { crewId, amount } = consequence.crewAffinityChange;\n  crewAffinity[crewId] = (crewAffinity[crewId] || 0) + amount;\n}\n```\n\n**Ejemplo:**\n- Dr. Thorn éxito: `crewAffinity['CREW_DR_ARIS_THORN'] += 1`\n- Dr. Thorn fallo: `crewAffinity['CREW_DR_ARIS_THORN'] -= 1`\n\n**Uso actual:** Registrado pero no tiene efecto mecánico visible\n\n---\n\n## 🏆 LOGROS IMPLEMENTADOS\n\nUbicación: `PlayerState.achievements[]`\n\n**Implementados:**\n\n| ID | Nombre | Activador | XP Bonus |\n|----|--------|-----------|----------|\n| `GHOST_IN_THE_MACHINE` | Ghost in the Machine | Éxito decodificar Transmisión Fantasma | 40 XP |\n\n**Sistema:**\n```typescript\nif (consequence.achievementId) {\n  playerState.achievements.push(achievementId);\n}\n```\n\n---\n\n## 📊 ESTADÍSTICAS DE IMPLEMENTACIÓN\n\n### **Eventos:**\n- Total eventos: **4** (2 Encuentro + 2 Peligro)\n- Opciones totales: **6** (3 + 2 + 1 + 1)\n- Opciones con requisitos: **2** (crew requirement, flag requirement)\n- Opciones con probabilidad: **2** (75%, 60%)\n\n### **Narrativa:**\n- Líneas de intro text: **~10 párrafos**\n- Personajes mencionados: **1** (Dr. Aris Thorn)\n- Banderas narrativas: **2 definidas** (1 activa, 1 bloqueada)\n- Logros: **1 implementado**\n\n### **Requisitos de Opción:**\n- Crew requirement: **1** (Dr. Aris Thorn)\n- Credits requirement: **0**\n- Narrative flag requirement: **1** (knows_vex_code - bloqueado)\n- Ninguno: **4** (siempre disponibles)\n\n---\n\n## 🔴 LIMITACIONES ACTUALES\n\n1. **Eventos Limitados:**\n   - Solo 4 eventos totales\n   - Mazo se agota rápidamente\n   - Poca variedad en sector\n\n2. **Narrativa Lineal:**\n   - No hay arcos narrativos largos\n   - Cada evento es independiente\n   - No hay consecuencias a largo plazo más allá de banderas\n\n3. **Personajes Subutilizados:**\n   - 8 personajes definidos pero solo 1 con narrativa en eventos\n   - No hay diálogos complejos\n   - No hay arcos de personaje\n\n4. **Banderas Bloqueadas:**\n   - `knows_vex_code` no se puede obtener\n   - Opción [RESPONDER] permanentemente bloqueada\n   - Requerirá crear evento anterior que la active\n\n5. **Mecánicas Incompletas:**\n   - Sistema de moral implementado pero no usado\n   - Afinidad registrada pero sin efectos\n   - Logros registrados pero sin UI de logros\n\n---\n\n## 🛣️ PRÓXIMOS PASOS SUGERIDOS\n\n### **Corto Plazo (1-2 eventos):**\n1. Crear evento que active `knows_vex_code`\n2. Implementar opción [RESPONDER] completamente\n3. Crear 2-3 eventos más para llevar a 6-7\n\n### **Mediano Plazo (3-5 eventos):**\n1. Implementar narrativa para otros personajes\n2. Crear eventos con requisitos de múltiples personajes\n3. Sistema de consecuencias a largo plazo\n4. Arcos narrativos cortos (2-3 eventos relacionados)\n\n### **Largo Plazo (Campaña completa):**\n1. Arcos de personaje completos\n2. Evento final con múltiples finales posibles\n3. Integración total de Capitana Vex\n4. Sistema de decisiones que afecten el mapa/enemigos\n\n---\n\n## 📝 NOTAS TÉCNICAS\n\n### **Cómo agregar un evento nuevo:**\n\n1. Añadir a `ENCOUNTER_DECK` o `HAZARD_DECK` en `constants.ts`:\n```typescript\n{\n  id: 'enc_my_event',\n  title: 'Mi Evento',\n  type: NodeType.ENCOUNTER,\n  image: 'url',\n  introText: ['párrafo 1', 'párrafo 2'],\n  promptText: 'pregunta',\n  options: [{ ... }, { ... }]\n}\n```\n\n2. Implementar `consequence` callbacks\n3. Opcionalmente: agregar banderas, afinidad, logros\n4. El `eventManager` lo incluirá automáticamente\n\n### **Cómo agregar opción con requisito:**\n\n```typescript\n{\n  text: '[OPCIÓN]',\n  crewRequirement: 'CREW_ID', // o narrativeFlagRequirement\n  consequence: (state) => ({ ... })\n}\n```\n\n### **Sistema de Random Aleatorio:**\n\nUtiliza `Math.random()` para probabilidades. Para mejor control, existe `rng.ts` con RNG determinista (para testing).\n\n---\n\n## 📚 REFERENCIAS\n\n- Tipo `EventCardData`: `types.ts` línea ~120\n- Tipo `EventOption`: `types.ts` línea ~130\n- Constantes de eventos: `constants.ts` línea ~90\n- Servicio: `services/eventManager.ts`\n- Componente: `components/EventCard.tsx`\n- Datos de tripulación: `data/cards.ts` línea ~80\n\n---\n\n**Documento generado:** 2025-10-29  \n**Próxima revisión:** Después de implementar nuevos eventos\n"}